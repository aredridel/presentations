<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8">
  
  <!--[if lt IE 9]>
  <script src="lib/html5shim.js"></script>
  <![endif]-->  
  
  <!-- These are some core styles the slideshow app requires -->
  <link rel="stylesheet" href="lib/styles.css">
  
  <!-- These are the styles you'll add to make the slides look great -->
  <link rel="stylesheet" href="css/styles.css">

  <link rel='stylesheet' href='lib/syntaxhighlighter/styles/shCore.css'>
  <link rel='stylesheet' href='lib/syntaxhighlighter/styles/shThemeDefault.css'>
  
  <title>Controlling Complexity</title>
</head>
<body>
  <header>
    <h1>Controlling Complexity in the API</h1>
    <nav>
      <ul>
        <li><button id="prev-btn" title="Previous slide">Previous Slide</button></li>
        <li><span id="slide-number"></span>/<span id="slide-total"></span></li>
        <li><button id="next-btn" title="Next Slide">Next Slide</button></li>
      </ul>
    </nav>
  </header>
  <!-- {{{ deck -->
  <div id="deck">
    
    <!-- {{{ slides -->

    <!-- {{{ title -->
    <section>
      <hgroup>
        <h1>Controlling Complexity</h1>
        <h2>(In the API)</h2>
      </hgroup>
    </section>
    <!-- }}} -->

    <!-- {{{ introduction -->
    <section>
      <hgroup>
        <h1>What is complexity?</h1>
      </hgroup>
      <p>The natural result of organically grown systems</p>
      <p>Interconnectedness.</p>
      <p>Mushrooms</p>

    </section>

    <section>
      <h1>Mushrooms?!</h1>
      <p>Yes. Mushrooms.</p>
      <p><img src='http://dinhe.net/~aredridel/2005/08/21-blue-lakes-hike/img_4068.jpg' style='width: 40%'></p>
      <div class='action'>
          <p>Tasty</p>
          <p>Poisonous if it's the wrong kind</p>
          <p>Grows on rotting stuff</p>
          <p>Actually grows beneath the surface, popping up just when it's ripe</p>
      </div>
    </section>

    <section>
      <h1>An example</h1>
      <div class='action'>
        <script type='syntaxhighlighter' class="brush: php">
          class User {
             function getName() { ... }
             function getAddress() { ... }
             function getMap() { ... }
          }
        </script>
      </div>
    </section>

    <section>
      <h1>An example</h1>
      <script type='syntaxhighlighter' class="brush: php">
        class User {
            static function loadFromDatabase($id) { ... }
            function saveToDatabase() { ... }
            function getName() { ... }
            function getAddress() { ... }
            function getMap() { ... }
        }
      </script>
    </section>

    <section>
      <h1>An example</h1>
      <script type='syntaxhighlighter' class="brush: php">
          class User {
              static function loadFromDatabase($id) { ... }
              function saveToDatabase() { some conversion }
              function saveToMemcache() { ... }
              function getName() { ... }
              function setName() { validation here }
              function setNameByAdmin() { not validating here }
              function getAddress() { some formatting logic }
              function getMap() { ... }
          }
      </script>
      <div class='action'>
        <p>Mushrooms.</p>
        <p> If you never have to care what's in those methods, great...</p>
        <p>... but you do have to reason about the system as a whole</p>
      </div>
    </section>
    <!-- }}} -->

    <!-- {{{ granularity -->
    <section>
      <h1>Granularity</h1>
      <h2>Do you operate on a given type of object field-by-field?</h2>
      <script type='syntaxhighlighter' class="brush: php">
          class User {
              static function loadForDisplay($id) { ... }
              static function loadForEdit($id) { ... }
              function setName($name) { update the database }
              function setAddress($address) { update the database }
          }
      </script>
      <p>Lots of micro-optimizations. Small mutations are the key actions.</p>
      <div class='action'>
        <h2>Or do you operate on it as a whole?</h2>
        <script type='syntaxhighlighter' class="brush: php">
            class User {
                static function load($id) { ... }
                function validate() { ... }
                function save() { update the database just once }
            }
        </script>
        <p>Bigger pieces. You work with the whole thing all at once.</p>
      </div>
    </section>

    <section>
      <h1>Granularity</h1>
      <h2>Field-by-field</h2>
      <script type='syntaxhighlighter' class="brush: php">
        try {
          $user->setName('bob');
        } catch (validationException $e) {
          ... 
        }
      </script>

      <h2>Whole object</h2>
      <script type='syntaxhighlighter' class="brush: php">
        $user->name = 'bob';
        if (!$user->validate()) { ... }
      </script>
    </section>

    <section>
      <h1>Granularity</h1>
      <h2>Field-by-field</h2>
      <script type='syntaxhighlighter' class="brush: php">
        try {
          $user->setName('bob');
        } catch (validationException $e) {
          ... 
        }

        try {
          $user->setAddress('123 Main St.');
        } catch (validationException $e) {
          ... 
        }
      </script>

      <h2>Whole object</h2>
      <script type='syntaxhighlighter' class="brush: php">
        $user->name = 'bob';
        $user->address = '123 Main St';
        if (!$user->validate()) { ... }
      </script>
    </section>

    <!-- }}} -->

    <!-- {{{ representation -->
    <section>
      <h1>Representation</h1>
      <h2>Field-by-field</h2>
      <script type='syntaxhighlighter' class="brush: php">
        function toJSON() {
          return json_encode(array('name' => $this->getName(), 'address' => $this->getAddress()));
        }
      </script>
      <p>Everything in the object is locked up tight. Everything takes explicit conversion.</p>

      <h2>Whole object</h2>
      <script type='syntaxhighlighter' class="brush: php">
        function toJSON() {
          return json_encode($this);
        }
      </script>
      <p>We're working with the canonical representation.</p>
    </section>

    <section>
      <h1>Representation</h1>
      <h2>Field-by-field</h2>
      <script type='syntaxhighlighter' class="brush: php">
        function loadFromDatabase($row) {
          $this->setNameNoValidate($row['name']);
          $this->setAddressNoValidate($row['address']);
        }
      </script>
      <p>You have to extend the API to handle invalid data. What you've got inside your object is (assuming no bugs) good, but now you have to do validation before you put data in.</p>

      <h2>Whole object</h2>
      <script type='syntaxhighlighter' class="brush: php">
        function loadFromDatabase($row) {
          foreach($row as $key => $value) {
            $this->$key = $value;
          }
        }
      </script>
      <p>You can actually load invalid data and work with it in its own domain. No need to have an intermediate representation for not-yet-validated data.</p>
      <script type='syntaxhighlighter' class="brush: php">
        if($user->validate()) { ... }
      </script>
    </section>

    <!-- }}} -->

    <!-- {{{ lifecycle -->
    <section>
        <h1>Lifecycle</h1>
        <p>Does our User object last milliseconds? Hours? Days?</p>
        <p>In PHP, the answer is almost always 'milliseconds'. The entire object structure is torn down for each request. All state saved must be explicit.</p>
        <p>In a system like a router's firmware, where the same code will have long-lived instances for objects like route table entries, the lifecycle is very different. Objects may live for years. Those are state objects, and any change to their internal representation affects the system as a whole.</p>
    </section>
    <!-- }}} -->

    <!-- {{{ state -->
    <section>
    <h1>State Transitions</h1>
    <p>Bugs happen any place the state of the system can change.</p>
    <p>To reduce the amount of code that has to be analyzed to see a change's effect, we define points where the state can change, and enforce those.</p>
    <p>In our user object example, the system as a whole is affected only when the object is persisted. Our PHP doesn't talk much to external systems.</p>
    </section>

    <section>
      <h1> State Transitions</h1>
      <script type='syntaxhighlighter' class="brush: php">
          class User {
              static function loadFromDatabase($id) { ... }
              function saveToDatabase() { some conversion }
              function saveToMemcache() { ... }
              function getName() { ... }
              function setName() { validation here }
              function setNameByAdmin() { not validating here }
              function getAddress() { some formatting logic }
              function getMap() { ... }
          }
      </script>

      <p>State changes in line 3. And 4. And 6. And 7. And maybe in 8. Line 8 looks like a fantastic place to update our stored copy if we discover it's in an old format.</p>

      <p class='action'>There be dragons.</p>
    </section>

    <section>
      <h1>State Transitions</h1>
      <script type='syntaxhighlighter' class="brush: php">
          class User {
              public var $name;
              public var $address;
              function validate() { ... }
              function save() { ... }
          }
      </script>

      <p>State changes only when we save the object.</p>
    </section>

    <section>
      <h1>But how are you sure?</h1>
      <p>If this were Erlang, we'd match only valid objects. If this were OCaml, validated objects would be a different type, and we could declare that most of our functions only work with the persisted, validated state.</p>
      <p>This is PHP. We'll have to assert things are in the right state.</p>
      <script type='syntaxhighlighter' class="brush: php">
        function frobnicateWithMyUser($user) {
          assert('$user->getName()');
          assert('$user->getAddress()');
          assert('... the list goes on ...');

          // I sure hope I didn't miss one. I hope someone changing this 
          // code didn't add a new one elsewhere.

          // I can't be sure. I'll add more validation here.
        }
      </script>
      <div class='action'>
        <script type='syntaxhighlighter' class="brush: php">
          function frobnicateWithMyUser($user) {
            assert('$user->validate()');

            // This function is extra picky. I'll go add more validation 
            // in the user's validate method.
          }
        </script>
        <p>The state we really care about is "is it valid?". That's it. Better to define that in one place.</p>
      </div>
    </section>

    <!-- }}} -->

    <!-- }}} -->
    
  </div>
  <!-- }}} -->
  <script src="lib/jquery-1.6.4.min.js"></script>
  <script src="lib/jquery.jswipe-0.1.2.js"></script>  
  <script src="lib/htmlSlides.js"></script>
  <script src="lib/syntaxhighlighter/scripts/shCore.js"></script>
  <script src="lib/syntaxhighlighter/scripts/shBrushJScript.js"></script>
  <script src="lib/syntaxhighlighter/scripts/shBrushPhp.js"></script>
  <script>
    //Do our business when the DOM is ready for us
    $(function() {
      
      //One little option: hideToolbar (boolean; default = false)
      htmlSlides.init({ hideToolbar: true });

      SyntaxHighlighter.all()
      
    });
  </script>
  </body>
</html>
